#!/bin/bash
#
# srht - Upload files/scrots/urls to sr.ht (rip pomf & uguu)
# By onodera, modified by SirCmpwn

## CONFIGURATION
source ~/.config/srht

## FUNCTIONS

# This function sets $file to a selection scrot
selection() {
    uploadme="/tmp/scrot.png"

    maim --hidecursor -s --nokeyboard "$uploadme" 2> "/dev/null"
    if [[ "$?" -ge 1 ]]; then
        echo "Selection cancelled."
        exit 1
    fi

    word=selection
}

# This function sets $file to your clipboard contents
clipboard() {
    uploadme="/tmp/scrot.txt"

    xclip -o > "$uploadme"

    word=clipboard
}

# This function sets $file an url
url() {
    type="$(echo "$location" | rev | cut -d "." -f 1 | rev)"
    uploadme="/tmp/url.$type"

    wget --quiet "$location" -O "$uploadme"

    word=url
}

# This function sets $file a file
file() {
    if [[ -f "$location" ]]; then
        uploadme="$location"
    else
        echo "File not found."
        exit 1
    fi

    word=file
}

# This function sets $file to a full screen scrot
desktop() {
    uploadme="/tmp/scrot.png"

    maim --hidecursor "$uploadme"

    word=desktop
}

# This function compresses the file to jpeg
jpeg() {
    jpegd="/tmp/srht.jpg"

    convert "$uploadme" "$jpegd"

    uploadme="$jpegd"
}

# This function uploads the $file
upload() {
    url="$(curl --silent -F key="$key" -F file="@$uploadme" "https://sr.ht/api/upload" | grep -o -i "https://sr.ht/*.[a-z0-9._-]*")"
}

# This function logs the url,  copies the url to the clipboard, and/or opens the url in your browser
feedback() {
    # Copy url to clipboard
    if [[ "$clipboard" == true ]]; then
        echo -n "$url" | xclip -selection primary
        echo -n "$url" | xclip -selection clipboard
    fi

    # Log url
    if [[ "$log" == true ]]; then
        echo "$url" >> "$logfile"
    fi

    # Open url in browser
    if [[ "$browser" == true ]]; then
        xdg-open "$url"
    fi

    # Send notification
    if [[ "$notify" == true ]]; then
        notify-send "Upload complete: $url"
    fi

    echo "$url"
}

## EXECUTE

if [[ "$#" -ge 1 ]]; then
    case "$@" in
        -h|--help)
            echo "usage: srht [options] [file/url]"
            echo "options:"
            echo "  -h,   --help            print help and exit"
            echo "  -p,   --paste           upload your clipboard as text"
            echo "  -s,   --selection       upload selection scrot"
            echo "  -sj,  --selection-jpeg  upload selection scrot as a jpeg"
            echo "  -v,   --version         print version and exit"
            exit 0
            ;;
        -s|--selection)
            selection
            ;;
        -sj|--selection-jpeg)
            compress=1
            selection
            ;;
        -v|--version)
            echo "srht 0.9.1"
            exit 0
            ;;
        -p|--paste)
            clipboard
            ;;
        http*)
            location="$@"
            url
            ;;
        *)
            location="$@"
            file
            ;;
    esac
else
    desktop
fi


if [[ "$#" -eq 0 ]]; then
    desktop
fi

if [[ "$compress" -eq 1 ]]; then
    jpeg
fi

upload
feedback

