#!/bin/bash

gdb --args /usr/bin/telegram-desktop "$@" << EOF
tbreak _ZN3App9initMediaEv
commands
    # TODO find a way to change this value (it's in RO data)
    #set {int}(_ZN2st20historyMessageRadiusE) = 3

    # Make all circled images into rounded rectangles
    # mov $0xffff,%r9d
    set {short}(_ZNK5Image10pixCircledEN4Data10FileOriginEii+0) = 0xB941
    set {int}(_ZNK5Image10pixCircledEN4Data10FileOriginEii+2) = 0xFFFF
    # mov $0x1,%r8d
    set {short}(_ZNK5Image10pixCircledEN4Data10FileOriginEii+6) = 0xB841
    set {int}(_ZNK5Image10pixCircledEN4Data10FileOriginEii+8) = 0x01
    # jmpq <_ZNK5Image10pixRoundedEN4Data10FileOriginEii16ImageRoundRadiusN4base5flagsI8RectPartEE>
    set {char}(_ZNK5Image10pixCircledEN4Data10FileOriginEii+12) = 0xE9
    set {int}(_ZNK5Image10pixCircledEN4Data10FileOriginEii+13) = (_ZNK5Image10pixRoundedEN4Data10FileOriginEii16ImageRoundRadiusN4base5flagsI8RectPartEE) - (_ZNK5Image10pixCircledEN4Data10FileOriginEii + 17)

    # Make pins not notify by default
    # mov $0x0,%ecx (imm part only)
    set {int}(_ZN13PinMessageBox7prepareEv+488) = 0x0

    # Delete messages for everyone by default
    # inc %ecx
    set {short}(_ZN17DeleteMessagesBox7prepareEv+3064) = 0xC1FF

    # Patch out calls to HistoryWidget::enqueueMessageHighlight when mentioned
    # All NOPs
    set {char [6]}(_ZN12HistoryInner10paintEventEP11QPaintEvent+3371) = { 0x90, 0x90, 0x90, 0x90, 0x90, 0x90 }
    set {char [6]}(_ZN12HistoryInner10paintEventEP11QPaintEvent+3657) = { 0x90, 0x90, 0x90, 0x90, 0x90, 0x90 }
end
run
detach
quit
EOF
