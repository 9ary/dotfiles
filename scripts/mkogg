#!/usr/bin/env python3

import json
import math
import multiprocessing
import os
from pathlib import Path
import subprocess
import sys

music_path = Path("~/music").expanduser()
ogg_path = Path("~/ogg").expanduser()

max_sample_rate = 48000

ffprobe_cmd = "ffprobe -print_format json -show_streams".split()
def transocde(infile):
    outfile_tmp = infile.with_suffix(".ogg.tmp")
    outfile_tmp = ogg_path / outfile_tmp.relative_to(music_path)
    outfile = outfile_tmp.with_suffix("")
    if outfile.is_file():
        return
    if outfile_tmp.is_file():
        outfile_tmp.unlink()
    print(outfile.relative_to(ogg_path))
    outfile.parent.mkdir(parents=True, exist_ok=True)

    probe = subprocess.run(
        [*ffprobe_cmd, infile],
        stdout=subprocess.PIPE,
        stderr=subprocess.DEVNULL,
        check=True
    )
    probe = json.loads(probe.stdout.decode())

    encode_args = []
    for stream in probe["streams"]:
        if stream["codec_type"] == "audio":
            index = stream["index"]

            sample_rate = int(stream["sample_rate"])
            if sample_rate > max_sample_rate:
                target_sample_rate = int(
                    sample_rate / math.ceil(sample_rate / max_sample_rate)
                )
                encode_args += f"-ar:0:{index} {target_sample_rate}".split()

    encode_cmd = [
        *"ffmpeg -y -i".split(),
        infile,
        *(
            "-map 0:a -metadata R128_ALBUM_GAIN= -metadata R128_TRACK_GAIN= "
            "-c:a libopus -b:a 192k -vbr on -f ogg"
        ).split(),
        *encode_args,
        outfile_tmp,
    ]

    subprocess.run(
        encode_cmd,
        stderr=subprocess.DEVNULL,
        stdin=subprocess.DEVNULL,
        check=True
    )

    outfile_tmp.rename(outfile)

def main():
    if len(sys.argv) <= 1:
        print("No input")
        return

    infiles = []
    for arg in sys.argv[1:]:
        for root, dirs, files in os.walk(music_path / arg):
            root = Path(root)
            for f in files:
                f = root / f
                if f.suffix.lower() in (".flac", ".ogg") \
                        and "instrumental" not in f.name.lower() \
                        and "5.1 mix" not in f.name.lower():
                    infiles.append(f)

    with multiprocessing.Pool() as p:
        p.map(transocde, infiles)

main()
